<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tickets Viewer</title>

  <link rel="stylesheet" href="static/css/normalize.css">
  <link rel="stylesheet" href="static/css/bootstrap-grid.css">
  <link rel="stylesheet" href="static/css/main.css">

  <style>
    :root { --left-w: 320px; }

    html, body {
      height: 100%;
      margin: 0;
    }

    .app {
      display: flex;
      height: 100vh;
      overflow: hidden;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }

    .left {
      width: var(--left-w);
      min-width: 180px;
      border-right: 1px solid #e6e6e6;
      padding: 12px;
      box-sizing: border-box;
      background: #fafafa;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      padding-top: 20px;  /* added margin/padding at top */
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      box-sizing: border-box;
      min-width: 0;
      overflow: hidden;
    }

    .ticket-list { list-style: none; padding: 0; margin: 0; }
    .ticket-item {
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 6px;
      border: 1px solid transparent;
      background: white;
    }
    .ticket-item:hover { background: #f2f8ff; }
    .ticket-item.active { background: #e8f1ff; border-color: #2b90ff; }
    .ticket-item.seen .ticket-title { opacity: 0.8; }
    .ticket-title { font-weight: 600; font-size: 13px; }
    .ticket-meta { font-size: 12px; color: #666; margin-top: 4px; }

    .viewer-frame {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 100%;
      min-height: 0;
    }

    @media (max-width: 900px) {
      .left { width: 40%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="left">
      <ul id="ticketList" class="ticket-list" aria-live="polite"></ul>
    </aside>

    <main class="main">
      <iframe id="viewer" class="viewer-frame" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
    </main>
  </div>

<script>
const MANIFEST = "tickets_html/manifest.json";
const SEEN_KEY = "tickets_seen_v1";
const LAST_KEY = "tickets_last_v1";

let manifest = [];
let seen = new Set(JSON.parse(localStorage.getItem(SEEN_KEY) || "[]"));
let last = localStorage.getItem(LAST_KEY) || null;

const ticketListEl = document.getElementById("ticketList");
const viewer = document.getElementById("viewer");

function renderList() {
  ticketListEl.innerHTML = "";

  manifest.forEach(item => {
    const li = document.createElement("li");
    li.className = "ticket-item";
    li.dataset.filename = item.filename;
    li.dataset.url = item.url;

    const title = document.createElement("div");
    title.className = "ticket-title";
    title.textContent = item.filename;

    const meta = document.createElement("div");
    meta.className = "ticket-meta";
    meta.textContent = `${item.date} Â· ${item.url}`;

    li.appendChild(title);
    li.appendChild(meta);

    if (seen.has(item.filename)) li.classList.add("seen");
    if (last === item.filename) li.classList.add("active");

    li.addEventListener("click", () => {
      document.querySelectorAll(".ticket-item.active").forEach(x => x.classList.remove("active"));
      li.classList.add("active");

      if (!seen.has(item.filename)) {
        seen.add(item.filename);
        localStorage.setItem(SEEN_KEY, JSON.stringify([...seen]));
        li.classList.add("seen");
      }

      last = item.filename;
      localStorage.setItem(LAST_KEY, last);

      viewer.src = item.url;
    });

    ticketListEl.appendChild(li);
  });
}

function fetchManifest() {
  fetch(MANIFEST, {cache: "no-cache"})
    .then(r => {
      if (!r.ok) throw new Error("Manifest not found: " + r.status);
      return r.json();
    })
    .then(data => {
      manifest = data.slice().sort((a,b) => (b.date || "").localeCompare(a.date || ""));
      renderList();
      if (last) {
        const el = Array.from(document.querySelectorAll(".ticket-item")).find(it => it.dataset.filename === last);
        if (el) el.click();
      }
    })
    .catch(err => {
      console.error(err);
      ticketListEl.innerHTML = `<li class="ticket-item"><div class="ticket-title">Error loading manifest</div><div class="ticket-meta">${err.message}</div></li>`;
    });
}

fetchManifest();

document.addEventListener("keydown", (e) => {
  if (e.key === 'j' || e.key === 'k') {
    const items = Array.from(document.querySelectorAll('.ticket-item'));
    if (!items.length) return;
    let idx = items.findIndex(i => i.classList.contains('active'));
    if (idx === -1) idx = 0;
    else idx = (e.key === 'j') ? Math.min(items.length-1, idx+1) : Math.max(0, idx-1);
    items[idx].click();
    items[idx].scrollIntoView({block:"nearest"});
  }
});
</script>
</body>
</html>
